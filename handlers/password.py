"""
Password handler for PDF Telegram Bot.
Handles adding and removing password protection from PDF files.
"""

from telegram import Update
from telegram.ext import ContextTypes
from telegram.constants import ChatAction

from utils import file_manager, pdf_ops, analytics
import config


async def protect_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    Handle /protect command - Add password protection to PDF.
    
    Usage: /protect <password>
    
    Args:
        update: Telegram update object
        context: Telegram context object
    """
    user_id = update.effective_user.id
    
    # Track user activity
    analytics.track_user(update.effective_user, 'protect')
    
    # Check if user has uploaded PDF file
    pdf_files = context.user_data.get('pdf_files', [])
    
    if not pdf_files:
        await update.message.reply_text(
            "‚ö†Ô∏è **No PDF found!**\n\n"
            "Please send a PDF file first, then use /protect.\n\n"
            "**Example:**\n"
            "1. Send your PDF file\n"
            "2. Type /protect MyPassword123\n\n"
            "**Password tips:**\n"
            "‚Ä¢ Use strong passwords (8+ characters)\n"
            "‚Ä¢ Mix letters, numbers, and symbols\n"
            "‚Ä¢ Avoid common words\n\n"
            "üí° Remember your password - you'll need it to open the PDF!",
            parse_mode='Markdown'
        )
        return
    
    # Check if multiple PDFs uploaded
    if len(pdf_files) > 1:
        await update.message.reply_text(
            "‚ö†Ô∏è **Multiple PDFs detected!**\n\n"
            f"You've uploaded {len(pdf_files)} PDFs.\n"
            f"Protection works with **one PDF at a time**.\n\n"
            f"Please use /cancel and send only one PDF file.",
            parse_mode='Markdown'
        )
        return
    
    # Get password from command
    command_parts = update.message.text.split(maxsplit=1)
    
    if len(command_parts) < 2:
        await update.message.reply_text(
            "‚ö†Ô∏è **Missing password!**\n\n"
            "**How to use:**\n"
            "/protect <password>\n\n"
            "**Examples:**\n"
            "‚Ä¢ /protect MySecretPass123\n"
            "‚Ä¢ /protect Company@2024\n"
            "‚Ä¢ /protect MyP@ssw0rd!\n\n"
            "**Password requirements:**\n"
            "‚Ä¢ Minimum 4 characters\n"
            "‚Ä¢ Can include letters, numbers, symbols\n"
            "‚Ä¢ No spaces recommended\n\n"
            "üí° **Important:** Remember this password!\n"
            "You'll need it to open the PDF.",
            parse_mode='Markdown'
        )
        return
    
    password = command_parts[1].strip()
    
    # Validate password
    if len(password) < 4:
        await update.message.reply_text(
            "‚ö†Ô∏è **Password too short!**\n\n"
            "Password must be at least **4 characters** long.\n\n"
            "Please use a stronger password for better security.",
            parse_mode='Markdown'
        )
        return
    
    if len(password) > 128:
        await update.message.reply_text(
            "‚ö†Ô∏è **Password too long!**\n\n"
            "Password must be less than **128 characters**.\n\n"
            "Please use a shorter password.",
            parse_mode='Markdown'
        )
        return
    
    pdf_path = pdf_files[0]
    
    # Get original PDF info
    pdf_info = pdf_ops.get_pdf_info(pdf_path)
    original_size = file_manager.get_file_size_mb(pdf_path)
    
    # Check if PDF is already encrypted
    if pdf_info['encrypted']:
        await update.message.reply_text(
            "‚ö†Ô∏è **PDF is already password-protected!**\n\n"
            "This PDF already has password protection.\n\n"
            "**To change the password:**\n"
            "1. Use /unlock to remove current password\n"
            "2. Then use /protect with new password\n\n"
            "üí° You'll need the current password to unlock it.",
            parse_mode='Markdown'
        )
        return
    
    # Show processing message
    processing_msg = await update.message.reply_text(
        f"üîê **Adding password protection...**\n\n"
        f"üìÑ **PDF Info:**\n"
        f"   Pages: {pdf_info['pages']}\n"
        f"   Size: {original_size:.2f} MB\n\n"
        f"üîí Encrypting with your password...\n"
        f"‚è≥ Please wait...",
        parse_mode='Markdown'
    )
    
    # Send typing action
    await context.bot.send_chat_action(
        chat_id=update.effective_chat.id,
        action=ChatAction.UPLOAD_DOCUMENT
    )
    
    try:
        # Get user directory
        user_dir = file_manager.get_user_dir(user_id)
        output_path = user_dir / "protected.pdf"
        
        # Add password protection
        pdf_ops.protect_pdf(pdf_path, output_path, password)
        
        # Get file size
        protected_size = file_manager.get_file_size_mb(output_path)
        
        # Update processing message
        await processing_msg.edit_text(
            f"‚úÖ **Password protection added!**\n\n"
            f"üìÑ Pages: {pdf_info['pages']}\n"
            f"üìä Size: {protected_size:.2f} MB\n"
            f"üîí Password: {'*' * len(password)}\n\n"
            f"üì§ Sending your protected file...",
            parse_mode='Markdown'
        )
        
        # Send protected PDF
        with open(output_path, 'rb') as pdf_file:
            await update.message.reply_document(
                document=pdf_file,
                filename="protected.pdf",
                caption=f"üîí **Your PDF is now password-protected!**\n\n"
                       f"üìÑ Pages: {pdf_info['pages']}\n"
                       f"üìä Size: {protected_size:.2f} MB\n\n"
                       f"‚ö†Ô∏è **IMPORTANT:**\n"
                       f"‚Ä¢ Save your password in a secure place\n"
                       f"‚Ä¢ You'll need it to open this PDF\n"
                       f"‚Ä¢ Cannot be recovered if forgotten\n\n"
                       f"üí° Password length: {len(password)} characters",
                parse_mode='Markdown'
            )
        
        # Delete the message containing the password for security
        try:
            await update.message.delete()
        except:
            pass  # User might have disabled message deletion
        
        # Delete processing message
        await processing_msg.delete()
        
        # Clean up user files
        file_manager.cleanup_user_files(user_id)
        context.user_data.clear()
        
        # Send completion message
        await update.message.reply_text(
            "üéâ **All done!**\n\n"
            "Your PDF is now securely protected.\n\n"
            "**Security Tips:**\n"
            "‚Ä¢ Store your password safely\n"
            "‚Ä¢ Use different passwords for different files\n"
            "‚Ä¢ Share password separately from the file\n\n"
            "Want to protect more PDFs? Send a new file! üöÄ",
            parse_mode='Markdown'
        )
    
    except Exception as e:
        # Handle errors
        error_message = str(e)
        
        await processing_msg.edit_text(
            "‚ùå **Protection failed!**\n\n"
            f"**Error:** {error_message}\n\n"
            "**Possible reasons:**\n"
            "‚Ä¢ PDF is corrupted\n"
            "‚Ä¢ PDF has restrictions that prevent encryption\n"
            "‚Ä¢ Insufficient system resources\n\n"
            "üí° **Try:**\n"
            "‚Ä¢ Use /cancel and upload file again\n"
            "‚Ä¢ Check if PDF opens normally\n"
            "‚Ä¢ Try a different PDF file",
            parse_mode='Markdown'
        )
        
        # Clean up on error
        file_manager.cleanup_user_files(user_id)
        context.user_data.clear()


async def unlock_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    Handle /unlock command - Remove password protection from PDF.
    
    Usage: /unlock <password>
    
    Args:
        update: Telegram update object
        context: Telegram context object
    """
    user_id = update.effective_user.id
    
    # Track user activity
    analytics.track_user(update.effective_user, 'unlock')
    
    # Check if user has uploaded PDF file
    pdf_files = context.user_data.get('pdf_files', [])
    
    if not pdf_files:
        await update.message.reply_text(
            "‚ö†Ô∏è **No PDF found!**\n\n"
            "Please send a password-protected PDF file first, then use /unlock.\n\n"
            "**Example:**\n"
            "1. Send your protected PDF file\n"
            "2. Type /unlock YourPassword123\n\n"
            "üí° You need the correct password to unlock the PDF!",
            parse_mode='Markdown'
        )
        return
    
    # Check if multiple PDFs uploaded
    if len(pdf_files) > 1:
        await update.message.reply_text(
            "‚ö†Ô∏è **Multiple PDFs detected!**\n\n"
            f"You've uploaded {len(pdf_files)} PDFs.\n"
            f"Unlock works with **one PDF at a time**.\n\n"
            f"Please use /cancel and send only one PDF file.",
            parse_mode='Markdown'
        )
        return
    
    # Get password from command
    command_parts = update.message.text.split(maxsplit=1)
    
    if len(command_parts) < 2:
        await update.message.reply_text(
            "‚ö†Ô∏è **Missing password!**\n\n"
            "**How to use:**\n"
            "/unlock <password>\n\n"
            "**Examples:**\n"
            "‚Ä¢ /unlock MySecretPass123\n"
            "‚Ä¢ /unlock Company@2024\n\n"
            "üí° You must provide the correct password\n"
            "that was used to protect this PDF.",
            parse_mode='Markdown'
        )
        return
    
    password = command_parts[1].strip()
    pdf_path = pdf_files[0]
    
    # Get original PDF info (will fail if password is wrong)
    original_size = file_manager.get_file_size_mb(pdf_path)
    
    # Show processing message
    processing_msg = await update.message.reply_text(
        f"üîì **Removing password protection...**\n\n"
        f"üìä Size: {original_size:.2f} MB\n\n"
        f"üîê Verifying password...\n"
        f"‚è≥ Please wait...",
        parse_mode='Markdown'
    )
    
    # Send typing action
    await context.bot.send_chat_action(
        chat_id=update.effective_chat.id,
        action=ChatAction.UPLOAD_DOCUMENT
    )
    
    try:
        # Get user directory
        user_dir = file_manager.get_user_dir(user_id)
        output_path = user_dir / "unlocked.pdf"
        
        # Remove password protection
        pdf_ops.unlock_pdf(pdf_path, output_path, password)
        
        # Get PDF info after unlocking
        pdf_info = pdf_ops.get_pdf_info(output_path)
        unlocked_size = file_manager.get_file_size_mb(output_path)
        
        # Update processing message
        await processing_msg.edit_text(
            f"‚úÖ **Password removed successfully!**\n\n"
            f"üìÑ Pages: {pdf_info['pages']}\n"
            f"üìä Size: {unlocked_size:.2f} MB\n\n"
            f"üì§ Sending your unlocked file...",
            parse_mode='Markdown'
        )
        
        # Send unlocked PDF
        with open(output_path, 'rb') as pdf_file:
            await update.message.reply_document(
                document=pdf_file,
                filename="unlocked.pdf",
                caption=f"üîì **Your PDF is now unlocked!**\n\n"
                       f"üìÑ Pages: {pdf_info['pages']}\n"
                       f"üìä Size: {unlocked_size:.2f} MB\n\n"
                       f"‚úÖ Password protection removed\n"
                       f"üìñ PDF can now be opened without password\n\n"
                       f"üí° Want to protect it again? Use /protect",
                parse_mode='Markdown'
            )
        
        # Delete the message containing the password for security
        try:
            await update.message.delete()
        except:
            pass  # User might have disabled message deletion
        
        # Delete processing message
        await processing_msg.delete()
        
        # Clean up user files
        file_manager.cleanup_user_files(user_id)
        context.user_data.clear()
        
        # Send completion message
        await update.message.reply_text(
            "üéâ **All done!**\n\n"
            "Your PDF is now accessible without a password.\n\n"
            "Want to unlock more PDFs? Send a new file! üöÄ",
            parse_mode='Markdown'
        )
    
    except ValueError as e:
        # Wrong password error
        await processing_msg.edit_text(
            "‚ùå **Incorrect password!**\n\n"
            "The password you provided is incorrect.\n\n"
            "**Please try again:**\n"
            "1. Check your password (case-sensitive)\n"
            "2. Make sure there are no extra spaces\n"
            "3. Use /unlock <correct_password>\n\n"
            "üí° If you forgot the password, you cannot unlock this PDF.",
            parse_mode='Markdown'
        )
        
        # Don't clean up files - let user try again
    
    except Exception as e:
        # Handle other errors
        error_message = str(e)
        
        await processing_msg.edit_text(
            "‚ùå **Unlock failed!**\n\n"
            f"**Error:** {error_message}\n\n"
            "**Possible reasons:**\n"
            "‚Ä¢ Incorrect password\n"
            "‚Ä¢ PDF is corrupted\n"
            "‚Ä¢ PDF is not password-protected\n"
            "‚Ä¢ PDF uses unsupported encryption\n\n"
            "üí° **Try:**\n"
            "‚Ä¢ Verify the password is correct\n"
            "‚Ä¢ Check if PDF is actually protected\n"
            "‚Ä¢ Try opening PDF in a PDF reader first",
            parse_mode='Markdown'
        )
        
        # Clean up on error
        file_manager.cleanup_user_files(user_id)
        context.user_data.clear()